---
- name: Configure and Install Datadog
  block:
    - name: Install apt-transport-https
      apt:
        pkg: apt-transport-https

    - name: Add Datadog deb repo
      lineinfile:
        dest: /etc/apt/sources.list
        line: deb https://apt.datadoghq.com/ stable 6

    - name: Install DD keys
      command: apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 382E94DE

    - name: Install DD agent
      apt:
        update_cache: yes
        pkg: datadog-agent
        state: present

    - name: Copy Config File
      template:
        src: templates/datadog.j2.yaml
        dest: /etc/datadog-agent/datadog.yaml
        owner: dd-agent
        mode: 0600

    - name: Attach dd-agent to docker
      user:
        name: dd-agent
        append: yes
        groups: docker

    - name: Enable Docker Agent
      template:
        src: templates/docker.j2.yaml
        dest: /etc/datadog-agent/conf.d/docker.d/conf.yaml
        owner: dd-agent
        mode: 0600

    - name: Create JournalD conf dir
      file:
        path: /etc/datadog-agent/conf.d/journald.d
        state: directory
        owner: dd-agent
        group: dd-agent
        mode: 0755

    - name: Enable JournalD log explorer
      template:
        src: templates/journald.j2.yaml
        dest: /etc/datadog-agent/conf.d/journald.d/conf.yaml
        owner: dd-agent
        group: dd-agent
        mode: 0644

    - name: Attach dd-agent to systemd-journald
      user:
        name: dd-agent
        append: yes
        groups: systemd-journal

    - name: Modify Consul Integration
      template:
        src: templates/consul.j2.yaml
        dest: /etc/datadog-agent/conf.d/consul.d/conf.yaml
        owner: dd-agent
        group: dd-agent
        mode: 0644

    - name: Enable DD Service at Boot
      command: systemctl enable datadog-agent
