---
- name: Enable Github PAT Access
  environment:
    VAULT_TOKEN: "{{ vault_token }}"
  when: "'github/' not in auth_methods"
  block:
    - name: Enable Github Auth
      command: vault auth enable github

    - name: Only for this org
      command: "vault write auth/github/config organization={{github_org}}"

    - name: Upload Dev Policy
      copy:
        src: dev-policy.hcl
        dest: /root/policies/dev-policy.hcl

    - name: Write Dev Policy to vault
      command: "vault policy write dev-policy /root/policies/dev-policy.hcl"

    - name: Map team name to dev policy
      command: "vault write auth/github/map/teams/{{dev_team}} value=dev-policy"
