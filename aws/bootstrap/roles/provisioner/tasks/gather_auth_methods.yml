---
- name: Gather Auth Methods
  environment:
    VAULT_TOKEN: "{{ vault_token }}"

  block:
    - command: 'vault auth list -format json'
      register: auth_list

    - set_fact:
        auth_methods: "{{ auth_list.stdout | from_json | json_query('keys(@)') }}"

    - command: 'vault policy list -format json'
      register: policy_list_raw

    - set_fact:
        policy_list: "{{ policy_list_raw.stdout | from_json }}"

    - command: 'vault secrets list -format json'
      register: backend_list_raw

    - set_fact:
        backend_list: "{{ backend_list_raw.stdout | from_json | json_query('keys(@)') }}"

    - name: Create Default KV Area
      when: "'secret/' not in backend_list"
      command: "vault secrets enable -version=1 -path=secret kv"

    - name: Get list of Secret KV Subkeys
      command: 'vault kv list -format=json secret'
      register: secrets_list_raw
      ignore_errors: true

    - set_fact:
        secrets_list: "{{ secret_list_raw.stdout | from_json | json_query('keys(@)') if secret_list_raw is defined else [] }}"
