---
- name: Enable PKI for OpenVPN
  environment:
    VAULT_TOKEN: "{{ vault_token }}"
  when: "vars['vpn_domain'] + '/' not in backend_list"
  block:
    - name: Enable PKI
      command: "vault secrets enable -path {{vpn_domain}} -description='PKI for VPN' -max-lease-ttl=87600h pki"

    - name: Generate a root cert
      command: "vault write {{vpn_domain}}/root/generate/internal common_name={{vpn_domain | regex_replace('_', '.')}} ttl=87600h"

    - name: Set CA/CRL URLs
      command: "vault write {{vpn_domain}}/config/urls issuing_certificates=${VAULT_ADDR}/v1/{{vpn_domain}}/ca crl_distribution_points=${VAULT_ADDR}/v1/{{vpn_domain}}/crl"

    - name: Set a Rule for the OpenVPN Certs
      command: "vault write {{vpn_domain}}/roles/openvpn allowed_domains='{{vpn_domain | regex_replace('_', '.')}}' allow_subdomains='true' max_ttl='8760h' allow_ip_sans=false allow_localhost=false"

