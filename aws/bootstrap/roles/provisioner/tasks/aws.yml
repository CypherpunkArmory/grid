---
# The instance itself is authenticated through the ec2-metadata service - they
# are assigned a role based on the instance profile and obtain their initial token
# that way.
#
# this token is used to obtain a nomad-server token for nomad servers.
#
# otherwise host ec2 instances have no access to vault
- name: Enable AWS Auth Access
  when: "'aws/' not in auth_methods"
  environment:
    VAULT_TOKEN: "{{ vault_token }}"
  block:
    - name: Enable AWS Auth
      command: vault auth enable aws

    - name: Report logged in AWS Principles by their ARN
      command: "vault write /auth/aws/config/identity iam_alias=full_arn"

    - name: Copy role to server
      copy:
        src: city-host-policy.hcl
        dest: /root/policies/city-host-policy.hcl

    - name: Write City Host Policy to vault
      command: "vault policy write city-host-policy /root/policies/city-host-policy.hcl"

    - name: Copy role to server
      copy:
        src: dmz-host-policy.hcl
        dest: /root/policies/dmz-host-policy.hcl

    - name: Write DMZ Host Policy to vault
      command: "vault policy write dmz-host-policy /root/policies/dmz-host-policy.hcl"

    - name: Copy role to server
      copy:
        src: lb-host-policy.hcl
        dest: /root/policies/lb-host-policy.hcl

    - name: Write LB Host Policy to vault
      command: "vault policy write lb-host-policy /root/policies/lb-host-policy.hcl"

    - name: Write policy attachment for the city_host IAM profile
      shell: |
         vault write auth/aws/role/city-host auth_type=iam bound_iam_principal_arn=arn:aws:iam::{{aws_account_id}}:role/city_host policies=city-host-policy max_ttl=500h
         vault write auth/aws/role/dmz-host auth_type=iam bound_iam_principal_arn=arn:aws:iam::{{aws_account_id}}:role/dmz_host policies=dmz-host-policy max_ttl=500h
         vault write auth/aws/role/lb-host auth_type=iam bound_iam_principal_arn=arn:aws:iam::{{aws_account_id}}:role/lb_host policies=lb-host-policy max_ttl=500h

- name: Enable AWS Secrets
  when: "'aws/' not in backend_list"
  environment:
    VAULT_TOKEN: "{{ vault_token }}"
  block:
    - name: Enable AWS Secret
      command: vault secrets enable aws

